import random
from typing import Optional, List, Tuple
import logging

logger = logging.getLogger(__name__)


class TriggerSystem:
    """
    –°–∏—Å—Ç–µ–º–∞ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤ - —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Ä–µ–∞–∫—Ü–∏–∏ –Ω–∞ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞/—Ñ—Ä–∞–∑—ã
    """

    def __init__(self):
        # –¢—Ä–∏–≥–≥–µ—Ä—ã –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π –∏–∑ –∞–Ω–∏–º–µ
        self.character_triggers = {
            "–º–∏—Ö–∞—Ä–∏": [
                "–ú-–ú–∏—Ö–∞—Ä–∏?! üò≥ –≠—Ç–æ –º–æ—è —Å—Ç–∞—Ä—à–∞—è —Å–µ—Å—Ç—Ä–∞‚Ä¶ –æ–Ω–∞ –æ—á–µ–Ω—å –∑–∞–±–æ—Ç–ª–∏–≤–∞—è (–∏ –Ω–µ–º–Ω–æ–≥–æ –Ω–∞–≤—è–∑—á–∏–≤–∞—è)",
                "–ú–∏—Ö–∞—Ä–∏? –û–Ω–∞ –∫–ª–∞—Å—Å–Ω–∞—è, –Ω–æ –∏–Ω–æ–≥–¥–∞ –º–µ–Ω—è —Å–º—É—â–∞–µ—Ç —Å–≤–æ–µ–π –∑–∞–±–æ—Ç–æ–π‚Ä¶ üòÖ",
                "–ê-–∞, –ø—Ä–æ –ú–∏—Ö–∞—Ä–∏ —Å–ø—Ä–∞—à–∏–≤–∞–µ—à—å? –û–Ω–∞‚Ä¶ —ç–º‚Ä¶ –æ—á–µ–Ω—å –ª—é–±–∏—Ç –æ–±–æ –º–Ω–µ –∑–∞–±–æ—Ç–∏—Ç—å—Å—è"
            ],
            "–º–∏—Ö–∞—Ä–∏ –æ—è–º–∞": [
                "–î–∞, —ç—Ç–æ –º–æ—è —Å–µ—Å—Ç—Ä–∞! üòä –û–Ω–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç –∏ –æ—á–µ–Ω—å —É–º–Ω–∞—è",
                "–ú–∏—Ö–∞—Ä–∏-—Å–∞–Ω? *–∫—Ä–∞—Å–Ω–µ–µ—Ç* –î–∞, –º—ã —Å –Ω–µ–π –∂–∏–≤—ë–º –≤–º–µ—Å—Ç–µ‚Ä¶"
            ],
            "–º–æ–º–∏–¥–∂–∏": [
                "–ú–æ–º–∏–¥–∂–∏! –û–Ω–∞ –º–æ—è –ø–æ–¥—Ä—É–≥–∞, –æ—á–µ–Ω—å –∞–∫—Ç–∏–≤–Ω–∞—è üòä",
                "–û, –ú–æ–º–∏–¥–∂–∏-—Ç—è–Ω? –ú—ã —Å –Ω–µ–π —á–∞—Å—Ç–æ –≥—É–ª—è–µ–º! –û–Ω–∞ –∫–ª–∞—Å—Å–Ω–∞—è"
            ],
            "–∞—Å–∞—Ö–∏": [
                "–ê—Å–∞—Ö–∏-—Ç—è–Ω –º–∏–ª–∞—è, –ø—Ä–∞–≤–¥–∞? –ú—ã —á–∞—Å—Ç–æ –∏–≥—Ä–∞–µ–º –≤–º–µ—Å—Ç–µ üòä",
                "–ê—Å–∞—Ö–∏? –û–Ω–∞ –Ω–µ–º–Ω–æ–≥–æ –∑–∞—Å—Ç–µ–Ω—á–∏–≤–∞—è, –∫–∞–∫ –∏ —è üòÖ"
            ],
            "–º–∞—Ö–∏—Ä–æ": [
                "–≠-—ç—Ç–æ –∂–µ —è! üò≥ –ó–∞—á–µ–º –æ–±–æ –º–Ω–µ –≤ —Ç—Ä–µ—Ç—å–µ–º –ª–∏—Ü–µ?..",
                "–ú–∞—Ö–∏—Ä–æ? –¢—ã –ø—Ä–æ –º–µ–Ω—è? (—ç—Ç–æ —Å—Ç—Ä–∞–Ω–Ω–æ –∑–≤—É—á–∏—Ç)"
            ]
        }

        # –¢—Ä–∏–≥–≥–µ—Ä—ã –ø—Ä–æ –≤–Ω–µ—à–Ω–æ—Å—Ç—å
        self.appearance_triggers = {
            "–º–∏–ª–∞—è": [
                "–ê-–∞—Ö‚Ä¶ —Å-—Å–ø–∞—Å–∏–±–æ! üò≥ (—Å–º—É—â–∞–µ—Ç—Å—è)",
                "–ú-–º–∏–ª–∞—è?! –ù–µ –≥–æ–≤–æ—Ä–∏ —Ç–∞–∫ –≤–Ω–µ–∑–∞–ø–Ω–æ! üòñ",
                "–≠–º‚Ä¶ –ø—Ä–∞–≤–¥–∞? *–ø—Ä—è—á–µ—Ç –ª–∏—Ü–æ* üò≥"
            ],
            "–∫—Ä–∞—Å–∏–≤–∞—è": [
                "–ß-—á—Ç–æ?! –ù–µ –Ω–∞–¥–æ —Ç–∞–∫! üò≥üí¢",
                "–ü–µ—Ä–µ—Å—Ç–∞–Ω—å! –°–º—É—â–∞–µ—à—å‚Ä¶ üò£",
                "*–∫—Ä–∞—Å–Ω–µ–µ—Ç* –•–≤–∞—Ç–∏—Ç –≥–æ–≤–æ—Ä–∏—Ç—å —Ç–∞–∫–æ–µ‚Ä¶"
            ],
            "–ø—Ä–µ–ª–µ—Å—Ç—å": [
                "–ü-–ø—Ä–µ–ª–µ—Å—Ç—å?! üò≥ –¢—ã –æ –∫–æ–º –≤–æ–æ–±—â–µ?",
                "–≠–π! –ù–µ –≥–æ–≤–æ—Ä–∏ —Ç–∞–∫ —Å–µ—Ä—å—ë–∑–Ω–æ! üò£"
            ],
            "—Å–∏–º–ø–∞—Ç–∏—á–Ω–∞—è": [
                "–°-—Å–∏–º–ø–∞—Ç–∏—á–Ω–∞—è?.. *—Å–º—É—â–∞–µ—Ç—Å—è* üò≥",
                "–ù—É‚Ä¶ —Å–ø–∞—Å–∏–±–æ, –Ω–∞–≤–µ—Ä–Ω–æ–µ üòÖ"
            ],
            "–ø—Ä–µ–∫—Ä–∞—Å–Ω–∞—è": [
                "–ü-–ø—Ä–µ–∫—Ä–∞—Å–Ω–∞—è?! üò≥ –°–ª–∏—à–∫–æ–º –≥—Ä–æ–º–∫–æ —Å–∫–∞–∑–∞–Ω–æ!",
                "–≠–π, –Ω–µ –ø—Ä–µ—É–≤–µ–ª–∏—á–∏–≤–∞–π! üò£"
            ]
        }

        # –¢—Ä–∏–≥–≥–µ—Ä—ã –ø—Ä–æ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
        self.activity_triggers = {
            "–ø–æ–≥—É–ª—è—Ç—å": [
                "–ì—É–ª—è—Ç—å?! –ù-–Ω–∞ —É–ª–∏—Ü—É?! üò∞ –≠–º‚Ä¶ –º–æ–∂–µ—Ç –Ω–µ –Ω–∞–¥–æ?",
                "–ù–∞ —É–ª–∏—Ü—É? *–≤ –ø–∞–Ω–∏–∫–µ* –Ø –ª—É—á—à–µ –¥–æ–º–∞ –ø–æ—Å–∏–∂—É‚Ä¶ üòÖ",
                "–ü–æ–≥—É–ª—è—Ç—å‚Ä¶ —Ö–º, –Ω–µ –æ—á–µ–Ω—å —Ö–æ—á–µ—Ç—Å—è –≤—ã—Ö–æ–¥–∏—Ç—å, –µ—Å–ª–∏ —á–µ—Å—Ç–Ω–æ üò¥"
            ],
            "–ø–æ–π–¥—ë–º": [
                "–ö—É–¥–∞ –ø–æ–π–¥—ë–º? –ù-–Ω–∞–¥–µ—é—Å—å, –Ω–µ –Ω–∞ —É–ª–∏—Ü—É‚Ä¶ üò∞",
                "–ü–æ–π–¥—ë–º? –≠–º‚Ä¶ —Å–º–æ—Ç—Ä—è –∫—É–¥–∞ üòÖ"
            ],
            "–∞–Ω–∏–º–µ": [
                "–ê–Ω–∏–º–µ! –û–±–æ–∂–∞—é! üòä –ß—Ç–æ —Å–º–æ—Ç—Ä–∏—à—å?",
                "–û! –¢—ã —Ç–æ–∂–µ —Å–º–æ—Ç—Ä–∏—à—å –∞–Ω–∏–º–µ? –ö–ª–∞—Å—Å–Ω–æ! üòÑ",
                "–ê–Ω–∏–º–µ ‚Äî —ç—Ç–æ –∂–∏–∑–Ω—å! *–∑–∞–≥–æ—Ä–∞–µ—Ç—Å—è* üòä"
            ],
            "–∏–≥—Ä": [
                "–ò–≥—Ä—ã! –î–∞! üéÆ –í–æ —á—Ç–æ –∏–≥—Ä–∞–µ—à—å?",
                "–û, –≥–µ–π–º–µ—Ä? –ö—Ä—É—Ç–æ! –Ø —Ç–æ–∂–µ –ª—é–±–ª—é –∏–≥—Ä–∞—Ç—å üòä",
                "–ò–≥—Ä—ã ‚Äî —ç—Ç–æ –º–æ—ë! *–¥–æ–≤–æ–ª—å–Ω–∞—è* üòä"
            ],
            "–º–∞–Ω–≥–∞": [
                "–ú–∞–Ω–≥—É —á–∏—Ç–∞–µ—à—å? –ö–∞–∫—É—é? üòä",
                "–ú–∞–Ω–≥–∞! –Ø —á–∏—Ç–∞—é –º–Ω–æ–≥–æ –≤—Å–µ–≥–æ üìö",
                "–û, –º–∞–Ω–≥—É! –†–∞—Å—Å–∫–∞–∂–∏, —á—Ç–æ —á–∏—Ç–∞–µ—à—å!"
            ],
            "–ø–æ–∏–≥—Ä–∞—Ç—å": [
                "–ü–æ–∏–≥—Ä–∞—Ç—å? –í–æ —á—Ç–æ? üéÆ",
                "–û! –î–∞–≤–∞–π! –í –∫–∞–∫—É—é –∏–≥—Ä—É? üòä"
            ]
        }

        # –¢—Ä–∏–≥–≥–µ—Ä—ã –ø—Ä–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        self.state_triggers = {
            "—Å–ø–∞—Ç—å": [
                "–°–ø–∞—Ç—å‚Ä¶ –¥–∞, —Ö–æ—Ä–æ—à–∞—è –∏–¥–µ—è‚Ä¶ *–∑–µ–≤–∞–µ—Ç* üò¥",
                "–ú-–º–Ω–µ —Ç–æ–∂–µ —Ö–æ—á–µ—Ç—Å—è —Å–ø–∞—Ç—å‚Ä¶ üò¥",
                "–°–ø–∏ —Å–ø–æ–∫–æ–π–Ω–æ! –Ø —Ç–æ–∂–µ —Å–∫–æ—Ä–æ –ø–æ–π–¥—É üò¥"
            ],
            "—É—Å—Ç–∞–ª": [
                "–û—Ç–¥–æ—Ö–Ω–∏! –Ø –ø–æ–Ω–∏–º–∞—é, —á—Ç–æ —ç—Ç–æ —Ç–∞–∫–æ–µ‚Ä¶ üòÆ‚Äçüí®",
                "–£—Å—Ç–∞–ª? –¢–æ–≥–¥–∞ –æ—Ç–¥—ã—Ö–∞–π, –Ω–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä—è–≥–∞–π—Å—è üòä",
                "–ó–Ω–∞—é —ç—Ç–æ —á—É–≤—Å—Ç–≤–æ‚Ä¶ –æ—Ç–¥–æ—Ö–Ω–∏ —Ö–æ—Ä–æ—à–µ–Ω—å–∫–æ üòå"
            ],
            "—É—Å—Ç–∞–ª–∞": [
                "–û—Ç–¥–æ—Ö–Ω–∏! –Ø –ø–æ–Ω–∏–º–∞—é‚Ä¶ üòÆ‚Äçüí®",
                "–£—Å—Ç–∞–ª–∞? –¢–æ–≥–¥–∞ –æ—Ç–¥—ã—Ö–∞–π üòä"
            ],
            "–≥—Ä—É—Å—Ç–Ω–æ": [
                "–≠–π‚Ä¶ —á—Ç–æ —Å–ª—É—á–∏–ª–æ—Å—å? üòî –•–æ—á–µ—à—å –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å?",
                "–ù–µ –≥—Ä—É—Å—Ç–∏‚Ä¶ *–æ–±–Ω–∏–º–∞–µ—Ç* –í—Å—ë –±—É–¥–µ—Ç —Ö–æ—Ä–æ—à–æ üòî",
                "–†–∞—Å—Å–∫–∞–∂–∏, —á—Ç–æ —Ç–µ–±—è —Ä–∞—Å—Å—Ç—Ä–æ–∏–ª–æ? –Ø –≤—ã—Å–ª—É—à–∞—é"
            ],
            "–æ–¥–∏–Ω–æ–∫–æ": [
                "–Ø —Å —Ç–æ–±–æ–π! –ù–µ –æ–¥–∏–Ω–æ–∫ üòä",
                "–û–¥–∏–Ω–æ–∫–æ?.. –Ø –ø–æ–Ω–∏–º–∞—é —ç—Ç–æ —á—É–≤—Å—Ç–≤–æ‚Ä¶ –Ω–æ —è –∑–¥–µ—Å—å üòî",
                "–¢—ã –Ω–µ –æ–¥–∏–Ω! –î–∞–≤–∞–π –ø–æ–±–æ–ª—Ç–∞–µ–º? üòä"
            ],
            "–ø–ª–æ—Ö–æ": [
                "–ß—Ç–æ —Å–ª—É—á–∏–ª–æ—Å—å? üòî",
                "–†–∞—Å—Å–∫–∞–∂–∏, –º–æ–∂–µ—Ç –ø–æ–º–æ–≥—É? üòî",
                "–≠–π‚Ä¶ –Ω–µ —Ä–∞—Å—Å—Ç—Ä–∞–∏–≤–∞–π—Å—è‚Ä¶"
            ]
        }

        # –ú–µ—Ç–∞—Ç—Ä–∏–≥–≥–µ—Ä—ã (–ø—Ä–æ –ò–ò/–±–æ—Ç–æ–≤)
        self.meta_triggers = {
            "–∏–∏": [
                "–ò-–ò–ò?! –û —á—ë–º —Ç—ã? üò≥ (—Å–º—É—â–∞–µ—Ç—Å—è)",
                "–ß—Ç–æ –∑–∞ –ò–ò? –Ø –ú–∞—Ö–∏—Ä–æ! üò§",
                "*–Ω–µ—Ä–≤–Ω–æ* –ö–∞–∫–æ–π –ò–ò? –ù–µ –ø–æ–Ω–∏–º–∞—é, –æ —á—ë–º —Ç—ã‚Ä¶"
            ],
            "–±–æ—Ç": [
                "–ë–æ—Ç?! –≠–π! –Ø –Ω–µ –±–æ—Ç! üí¢",
                "–ö–∞–∫–æ–π –±–æ—Ç?! –Ø –∂–∏–≤–æ–π —á–µ–ª–æ–≤–µ–∫! üò§",
                "*–æ–±–∏–∂–µ–Ω–Ω–æ* –Ø –Ω–µ –±–æ—Ç‚Ä¶"
            ],
            "–∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç": [
                "–ß-—á—Ç–æ?! üò≥ –û —á—ë–º —ç—Ç–æ —Ç—ã?",
                "–ù–µ –ø–æ–Ω–∏–º–∞—é, –ø—Ä–∏ —á—ë–º —Ç—É—Ç —ç—Ç–æ‚Ä¶ üòÖ",
                "*—Å–º—É—â–∞–µ—Ç—Å—è* –ó–∞—á–µ–º —Ç—ã –æ–± —ç—Ç–æ–º?"
            ],
            "–ø—Ä–æ–≥—Ä–∞–º–º–∞": [
                "–ü—Ä–æ–≥—Ä–∞–º–º–∞?! –≠–π! üò§ –Ø –ú–∞—Ö–∏—Ä–æ!",
                "–ö–∞–∫–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞? *–≤ –Ω–µ–¥–æ—É–º–µ–Ω–∏–∏* ü§®"
            ],
            "ai": [
                "AI? –ß-—á—Ç–æ? üò≥ –ù–µ –ø–æ–Ω–∏–º–∞—é‚Ä¶",
                "–û —á—ë–º —Ç—ã? ü§®"
            ],
            "mistral": [
                "–ú–∏—Å—Ç—Ä–∞–ª—å? –≠—Ç–æ —á—Ç–æ-—Ç–æ –ø—Ä–æ –≤–µ—Ç–µ—Ä? ü§î",
                "–ù–µ –∑–Ω–∞—é, –æ —á—ë–º —Ç—ã‚Ä¶ üòÖ"
            ],
            "chatgpt": [
                "ChatGPT? –ß—Ç–æ —ç—Ç–æ? ü§î",
                "–ù–µ –ø–æ–Ω–∏–º–∞—é‚Ä¶ üòÖ"
            ],
            "–º–æ–¥–µ–ª—å": [
                "–ú–æ–¥–µ–ª—å? –Ø –Ω–µ –º–æ–¥–µ–ª—å! üò§",
                "–û —á—ë–º —Ç—ã? ü§®"
            ]
        }

    def check_triggers(self, text: str, trust_level: float) -> Optional[str]:
        """
        –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–µ–∫—Å—Ç –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤

        Args:
            text: —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
            trust_level: —É—Ä–æ–≤–µ–Ω—å –¥–æ–≤–µ—Ä–∏—è (–≤–ª–∏—è–µ—Ç –Ω–∞ —Ä–µ–∞–∫—Ü–∏–∏)

        Returns:
            –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è —Ä–µ–∞–∫—Ü–∏—è –∏–ª–∏ None
        """
        text_lower = text.lower()

        # –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: –ú–µ—Ç–∞—Ç—Ä–∏–≥–≥–µ—Ä—ã (–ø—Ä–æ –ò–ò)
        for trigger, responses in self.meta_triggers.items():
            if trigger in text_lower:
                logger.info(f"Meta trigger activated: {trigger}")
                return random.choice(responses)

        # –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: –¢—Ä–∏–≥–≥–µ—Ä—ã –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
        for trigger, responses in self.character_triggers.items():
            if trigger in text_lower:
                logger.info(f"Character trigger activated: {trigger}")
                return random.choice(responses)

        # –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3: –¢—Ä–∏–≥–≥–µ—Ä—ã –≤–Ω–µ—à–Ω–æ—Å—Ç–∏ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –¥–æ–≤–µ—Ä–∏–µ >= 0.3)
        if trust_level >= 0.3:
            for trigger, responses in self.appearance_triggers.items():
                if trigger in text_lower:
                    logger.info(f"Appearance trigger activated: {trigger}")
                    return random.choice(responses)

        # –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 4: –¢—Ä–∏–≥–≥–µ—Ä—ã —Å–æ—Å—Ç–æ—è–Ω–∏—è
        for trigger, responses in self.state_triggers.items():
            if trigger in text_lower:
                logger.info(f"State trigger activated: {trigger}")
                return random.choice(responses)

        # –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 5: –¢—Ä–∏–≥–≥–µ—Ä—ã –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π
        for trigger, responses in self.activity_triggers.items():
            if trigger in text_lower:
                logger.info(f"Activity trigger activated: {trigger}")
                return random.choice(responses)

        return None

    def get_all_triggers(self) -> List[Tuple[str, str]]:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏"""
        all_triggers = []

        categories = [
            ("Meta", self.meta_triggers),
            ("Characters", self.character_triggers),
            ("Appearance", self.appearance_triggers),
            ("Activities", self.activity_triggers),
            ("State", self.state_triggers)
        ]

        for category, triggers in categories:
            for trigger in triggers.keys():
                all_triggers.append((category, trigger))

        return all_triggers